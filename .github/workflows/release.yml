name: Build & Release (MAUI)

on:
  workflow_dispatch: # To enable manual run of action

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  CONFIGURATION: Release
  UI_PROJECT: UI/UI.csproj

jobs:
  build_android:
    name: Build Android (macOS)
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (pinned via global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore
        run: dotnet restore ${{ env.UI_PROJECT }}

      - name: Build Android (APK)
        run: >
          dotnet publish ${{ env.UI_PROJECT }}
          -c ${{ env.CONFIGURATION }}
          -f net10.0-android
          /p:AndroidPackageFormat=apk
          /p:PublishTrimmed=true
          /p:RunAOTCompilation=true

      - name: Collect artifacts (android)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          APK="$(find UI/bin/${{ env.CONFIGURATION }}/net10.0-android -type f -name '*.apk' -print -quit || true)"
          [ -n "$APK" ] || { echo "APK not found" >&2; exit 1; }
          cp "$APK" "artifacts/OneDriveAlbums-android-${GITHUB_REF_NAME}.apk"

      - name: Upload workflow artifacts (android)
        uses: actions/upload-artifact@v4
        with:
          name: android
          path: artifacts/*

  build_ios:
    name: Build iOS + Upload TestFlight (macOS)
    runs-on: macos-26
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (pinned via global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Setup Ruby (Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore
        run: dotnet restore ${{ env.UI_PROJECT }}

      - name: Install Apple signing assets (cert + provisioning)
        shell: bash
        env:
          IOS_CERT_P12_BASE64: ${{ secrets.IOS_CERT_P12_BASE64 }}
          IOS_CERT_PASSWORD: ${{ secrets.IOS_CERT_PASSWORD }}
          IOS_PROVISION_BASE64: ${{ secrets.IOS_PROVISION_BASE64 }}
        run: |
          set -euo pipefail

          KEYCHAIN="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="temporary-keychain-password"

          CERT_P12_PATH="$RUNNER_TEMP/ios_signing_cert.p12"
          PP_PATH="$RUNNER_TEMP/profile.mobileprovision"

          printf '%s' "$IOS_CERT_P12_BASE64" | base64 --decode > "$CERT_P12_PATH"
          printf '%s' "$IOS_PROVISION_BASE64" | base64 --decode > "$PP_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"
          security set-keychain-settings -lut 21600 "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          # Make it the default so codesign can find identities
          security list-keychains -d user -s "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"

          # Import cert into keychain
          security import "$CERT_P12_PATH" -k "$KEYCHAIN" -P "$IOS_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Allow codesign to use the key without UI prompts
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          # Install provisioning profile
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i "$PP_PATH")")
          cp "$PP_PATH" "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "Available signing identities:"
          security find-identity -v -p codesigning "$KEYCHAIN"

      - name: Validate iOS key early (fail fast if invalid)
        shell: bash
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_P8_BASE64: ${{ secrets.ASC_P8_BASE64 }}
        run: |
          set -euo pipefail

          mkdir -p "$RUNNER_TEMP/appstoreconnect"
          KEY_PATH="$RUNNER_TEMP/appstoreconnect/AuthKey_${ASC_KEY_ID}.p8"

          # Decode secret safely and normalize line endings
          printf '%s' "$ASC_P8_BASE64" | base64 --decode | tr -d '\r' > "$KEY_PATH"
          chmod 600 "$KEY_PATH"

          # Validate the PEM (fail fast if malformed)
          openssl pkey -in "$KEY_PATH" -noout >/dev/null

          echo "App Store Connect key is valid"

      
      - name: Build iOS (IPA)
        timeout-minutes: 45
        run: >
          dotnet publish ${{ env.UI_PROJECT }}
          -c ${{ env.CONFIGURATION }}
          -f net10.0-ios
          /p:BuildIpa=true
          /p:RunAOTCompilation=true
          /p:PublishTrimmed=true
          /p:TrimMode=partial
          /p:MtouchLink=SdkOnly
          /p:ApplicationVersion=${{ github.run_number }}

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts

          IPA="$(find UI/bin/${{ env.CONFIGURATION }}/net10.0-ios -type f -name '*.ipa' -print -quit || true)"
          if [ -z "${IPA}" ]; then
            echo "IPA not found" >&2
            exit 1
          fi
          cp "${IPA}" "artifacts/OneDriveAlbums-ios-${GITHUB_REF_NAME}.ipa"

      - name: Upload iOS .ipa to TestFlight (Fastlane)
        shell: bash
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_P8_BASE64: ${{ secrets.ASC_P8_BASE64 }}
          IOS_BUNDLE_ID: ${{ vars.IOS_BUNDLE_ID }}
        run: |
          set -euo pipefail

          mkdir -p "$RUNNER_TEMP/appstoreconnect"
          KEY_PATH="$RUNNER_TEMP/appstoreconnect/AuthKey_${ASC_KEY_ID}.p8"

          # Decode secret safely and normalize line endings
          printf '%s' "$ASC_P8_BASE64" | base64 --decode | tr -d '\r' > "$KEY_PATH"
          chmod 600 "$KEY_PATH"

          # Validate the PEM (fail fast if malformed)
          openssl pkey -in "$KEY_PATH" -noout >/dev/null

          IPA="$(find UI/bin/${{ env.CONFIGURATION }}/net10.0-ios -type f -name '*.ipa' -print -quit)"
          if [ -z "$IPA" ]; then
            echo "IPA not found" >&2
            exit 1
          fi

          bundle exec fastlane ios upload_testflight \
            key_id:"$ASC_KEY_ID" \
            issuer_id:"$ASC_ISSUER_ID" \
            key_filepath:"$KEY_PATH" \
            ipa:"$IPA" \
            app_identifier:"$IOS_BUNDLE_ID"

      - name: Collect artifacts (ios)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts
          IPA="$(find UI/bin/${{ env.CONFIGURATION }}/net10.0-ios -type f -name '*.ipa' -print -quit || true)"
          [ -n "$IPA" ] || { echo "IPA not found" >&2; exit 1; }
          cp "$IPA" "artifacts/OneDriveAlbums-ios-${GITHUB_REF_NAME}.ipa"

      - name: Upload workflow artifacts (ios)
        uses: actions/upload-artifact@v4
        with:
          name: ios
          path: artifacts/*

  build_windows:
    name: Build Windows (MSIX, self-signed)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET (pinned via global.json)
        uses: actions/setup-dotnet@v4
        with:
          global-json-file: global.json

      - name: Install MAUI workload
        run: dotnet workload install maui --skip-manifest-update

      - name: Import signing certificate (PFX from repo)
        shell: pwsh
        env:
          PFX_PASSWORD: ${{ secrets.WIN_MSIX_PFX_PASSWORD }}
        run: |
          $ErrorActionPreference = "Stop"

          $pfxPath = Join-Path $PWD "build\signing\onedrivealbums.pfx"
          if (-not (Test-Path $pfxPath)) { throw "Missing PFX at $pfxPath" }

          $secure = ConvertTo-SecureString -String $env:PFX_PASSWORD -AsPlainText -Force
          $imported = Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation "Cert:\CurrentUser\My" -Password $secure
          if (-not $imported) { throw "PFX import failed" }

          "CERT_THUMBPRINT=$($imported.Thumbprint)" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Restore
        run: dotnet restore ${{ env.UI_PROJECT }}

      - name: Publish Windows (MSIX)
        shell: pwsh
        run: >
          dotnet publish ${{ env.UI_PROJECT }}
          -c ${{ env.CONFIGURATION }}
          -f net10.0-windows10.0.19041.0
          /p:GenerateAppxPackageOnBuild=true
          /p:AppxPackageSigningEnabled=true
          /p:PackageCertificateThumbprint="${{ env.CERT_THUMBPRINT }}"
          /p:PackageCertificateStoreLocation=CurrentUser
          /p:PackageCertificateStoreName=My
          /p:PublishTrimmed=false

      - name: Collect artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null

          $msix = Get-ChildItem -Path "UI\bin\${{ env.CONFIGURATION }}\net10.0-windows10.0.19041.0" -Recurse -Include *.msix,*.msixbundle | Select-Object -First 1
          if (-not $msix) { throw "MSIX/MSIXBUNDLE not found" }

          Copy-Item $msix.FullName "artifacts\OneDriveAlbums-windows-${env:GITHUB_REF_NAME}$($msix.Extension)" -Force
          Copy-Item "build\signing\onedrivealbums.cer" "artifacts\OneDriveAlbums-windows-${env:GITHUB_REF_NAME}.cer" -Force

      - name: Upload workflow artifacts (windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: artifacts/*

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build_android, build_ios, build_windows]
    steps:
      - name: Download artifacts (android)
        uses: actions/download-artifact@v4
        with:
          name: android
          path: artifacts

      - name: Download artifacts (ios)
        uses: actions/download-artifact@v4
        with:
          name: ios
          path: artifacts

      - name: Download artifacts (windows)
        uses: actions/download-artifact@v4
        with:
          name: windows
          path: artifacts

      - name: Create / Update Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build_${{ github.run_number }}
          name: build_${{ github.run_number }}
          generate_release_notes: true
          files: |
            artifacts/*