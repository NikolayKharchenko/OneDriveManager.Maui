name: Build & Release (MAUI)

on:
  workflow_dispatch: # To enable manual run of action

permissions:
  contents: write

env:
  DOTNET_NOLOGO: true
  CONFIGURATION: Release
  UI_PROJECT: UI/UI.csproj

jobs:
  build_mobile:
    name: Build Android + iOS (macOS)
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install MAUI workload
        run: dotnet workload install maui --skip-manifest-update

      - name: Restore
        run: dotnet restore ${{ env.UI_PROJECT }}

      - name: Build Android (APK)
        run: >
          dotnet publish ${{ env.UI_PROJECT }}
          -c ${{ env.CONFIGURATION }}
          -f net10.0-android
          /p:AndroidPackageFormat=apk
          /p:PublishTrimmed=false

      - name: Build iOS (IPA)
        run: >
          dotnet publish ${{ env.UI_PROJECT }}
          -c ${{ env.CONFIGURATION }}
          -f net10.0-ios
          /p:BuildIpa=true
          /p:PublishTrimmed=false

      - name: Collect artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts

          # Android APK
          APK="$(find UI/bin/${{ env.CONFIGURATION }}/net10.0-android -type f -name '*.apk' -print -quit || true)"
          if [ -z "${APK}" ]; then
            echo "APK not found" >&2
            exit 1
          fi
          cp "${APK}" "artifacts/OneDriveAlbums-android-${GITHUB_REF_NAME}.apk"

          # iOS IPA
          IPA="$(find UI/bin/${{ env.CONFIGURATION }}/net10.0-ios -type f -name '*.ipa' -print -quit || true)"
          if [ -z "${IPA}" ]; then
            echo "IPA not found" >&2
            exit 1
          fi
          cp "${IPA}" "artifacts/OneDriveAlbums-ios-${GITHUB_REF_NAME}.ipa"

      - name: Upload workflow artifacts (mobile)
        uses: actions/upload-artifact@v4
        with:
          name: mobile
          path: artifacts/*

  build_windows:
    name: Build Windows (MSIX, self-signed)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Install MAUI workload
        run: dotnet workload install maui --skip-manifest-update

      - name: Create self-signed code signing cert (PFX + CER)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null

          $subject = "CN=OneDriveAlbums Self-Signed"
          $pfxPassword = ConvertTo-SecureString -String "temporary-password" -Force -AsPlainText

          $cert = New-SelfSignedCertificate `
            -Type CodeSigningCert `
            -Subject $subject `
            -KeyAlgorithm RSA `
            -KeyLength 2048 `
            -HashAlgorithm SHA256 `
            -CertStoreLocation "Cert:\CurrentUser\My"

          Export-PfxCertificate -Cert $cert -FilePath "artifacts/onedrivealbums.pfx" -Password $pfxPassword | Out-Null
          Export-Certificate -Cert $cert -FilePath "artifacts/onedrivealbums.cer" | Out-Null

          "PFX_PATH=$pwd\artifacts\onedrivealbums.pfx" | Out-File -FilePath $env:GITHUB_ENV -Append
          "PFX_PASSWORD=temporary-password" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Restore
        run: dotnet restore ${{ env.UI_PROJECT }}

      - name: Publish Windows (MSIX)
        shell: pwsh
        run: >
          dotnet publish ${{ env.UI_PROJECT }}
          -c ${{ env.CONFIGURATION }}
          -f net10.0-windows10.0.19041.0
          /p:GenerateAppxPackageOnBuild=true
          /p:AppxPackageSigningEnabled=true
          /p:PackageCertificateKeyFile="${{ env.PFX_PATH }}"
          /p:PackageCertificatePassword="${{ env.PFX_PASSWORD }}"
          /p:PublishTrimmed=false

      - name: Collect artifacts
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          $msix = Get-ChildItem -Path "UI\bin\${{ env.CONFIGURATION }}\net10.0-windows10.0.19041.0" -Recurse -Include *.msix,*.msixbundle | Select-Object -First 1
          if (-not $msix) { throw "MSIX/MSIXBUNDLE not found" }

          Copy-Item $msix.FullName "artifacts\OneDriveAlbums-windows-${env:GITHUB_REF_NAME}$($msix.Extension)" -Force
          Copy-Item "artifacts\onedrivealbums.cer" "artifacts\OneDriveAlbums-windows-${env:GITHUB_REF_NAME}.cer" -Force

      - name: Upload workflow artifacts (windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows
          path: artifacts/*

  release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [build_mobile, build_windows]

    steps:
      - name: Download artifacts (mobile)
        uses: actions/download-artifact@v4
        with:
          name: mobile
          path: artifacts

      - name: Download artifacts (windows)
        uses: actions/download-artifact@v4
        with:
          name: windows
          path: artifacts

      - name: Create / Update Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/*